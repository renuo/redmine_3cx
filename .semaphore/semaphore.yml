version: v1.0
name: hermes_link
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets: []
  env_vars:
    - name: RAILS_ENV
      value: test
    - name: SEMAPHORE_CI
      value: "true"
    - name: DATABSE_ADAPTER
      value: "postgresql"
    - name: REDMINE_VERSION
      value: "5.1"
    - name: RUBY_VERSION
      value: "2.6.5"

blocks:
  - name: Linting
    dependencies: []
    execution_time_limit:
      minutes: 2
    task:
      jobs:
        - name: linter
          env_vars:
            - name: RUBY_VERSION
              value: "3.1.1"
          commands:
            - sem-version ruby $RUBY_VERSION -f
            - cache restore redmine-$REDMINE_VERSION
            - cd redmine
            - cd plugins
            - checkout
            - cp .semaphore/database.yml ../../config/database.yml
            - bin/setup
            - bin/fastcheck

  - name: Redmine Compatibility
    dependencies: []
    execution_time_limit:
      minutes: 3
    task:
      jobs:
        - name: caching
          commands:
            - if [[ "$REDMINE_VERSION" == "5.0" || "$REDMINE_VERSION" == "5.1" ]]; then RUBY_VERSION="3.1.1"; fi
            - git clone -b $REDMINE_VERSION-stable git@github.com:redmine/redmine.git
            - cache store redmine-$REDMINE_VERSION ./redmine
            - cd redmine/plugins
            - checkout
            - cache restore gems-$REDMINE_VERSION-$(checksum PluginGemfile)
            - bundle config set --local path vendor/bundle
            - BUNDLE_GEMFILE=PluginGemfile bundle install -j 4
            - cache store gems-$REDMINE_VERSION-$(checksum PluginGemfile) vendor/bundle
          matrix:
            - env_var: REDMINE_VERSION
              values: ["5.1", "5.0", "4.2", "4.1", "4.0"]
        - name: checks
          commands:
            - if [[ "$REDMINE_VERSION" == "5.0" || "$REDMINE_VERSION" == "5.1" ]]; then RUBY_VERSION="3.1.1"; fi
            - sem-version ruby $RUBY_VERSION -f
            - cache restore redmine-$REDMINE_VERSION
            - cd redmine
            - yarn
            - sem-service start postgres
            - '[ "$SEMAPHORE_DATABASE_ADAPTER" = "postgres" ] && sem-service start postgres'
            - '[ "$SEMAPHORE_DATABASE_ADAPTER" = "mysql" ] && sem-service start mysql'
            - cd plugins
            - checkout
            - cache restore gems-$REDMINE_VERSION-$(checksum PluginGemfile)
            - cp .semaphore/database.yml ../../config/database.yml
            - bin/setup
          matrix:
            - env_var: REDMINE_VERSION
              values: ["5.1", "5.0", "4.2", "4.1", "4.0"]
            - env_var: SEMAPHORE_DATABASE_ADAPTER
              values: ["postgresql", "mysql2"]
