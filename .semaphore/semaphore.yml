version: v1.0
name: hermes_link
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: cache
    task:
      jobs:
        - name: Cache Redmine 5.1
          commands:
            - git clone -b 5.1-stable git@github.com/redmine/redmine.git
            - cache store redmine-5.1 ./redmine
        - name: Cache Redmine 5.0
          commands:
            - git clone -b 5.0-stable git@github.com/redmine/redmine.git
            - cache store redmine-5.0 ./redmine
        - name: Cache Redmine 4.2
          commands:
            - git clone -b 4.2-stable git@github.com/redmine/redmine.git
            - cache store redmine-4.2 ./redmine
        - name: Cache Redmine 4.1
          commands:
            - git clone -b 4.1-stable git@github.com/redmine/redmine.git
            - cache store redmine-4.1 ./redmine
        - name: Cache Redmine 4.0
          commands:
            - git clone -b 4.0-stable git@github.com/redmine/redmine.git
            - cache store redmine-4.0 ./redmine
  - name: Redmine 5.1 tests
    execution_time_limit:
      minutes: 5
    dependencies: ["cache"]
    task:
      secrets: []
      env_vars:
        - name: RAILS_ENV
          value: test
        - name: SEMAPHORE_CI
          value: "true"

      prologue:
        commands:
          - sem-version ruby 3.1 -f
          - cache restore redmine-5.1 ./redmine
          - cd redmine
          - yarn
          - sem-service start postgres
          - cd plugins
          - checkout
          - cp .semaphore/database.yml ../../config/database.yml
          - bin/setup

      jobs:
        - name: linter
          commands:
            - bin/fastcheck
        - name: tests
          commands:
            - bin/check

  - name: Redmine 5.0 tests
    execution_time_limit:
      minutes: 5
    dependencies: ["cache"]
    task:
      secrets: []
      env_vars:
        - name: RAILS_ENV
          value: test
        - name: SEMAPHORE_CI
          value: "true"

      prologue:
        commands:
          - sem-version ruby 3.1 -f
          - cache restore redmine-5.0 ./redmine
          - cd redmine
          - yarn
          - sem-service start postgres
          - cd plugins
          - checkout
          - cp .semaphore/database.yml ../../config/database.yml
          - bin/setup

      jobs:
        - name: tests
          commands:
            - bin/check

  - name: Redmine 4.2 tests
    execution_time_limit:
      minutes: 5
    dependencies: ["cache"]
    task:
      secrets: []
      env_vars:
        - name: RAILS_ENV
          value: test
        - name: SEMAPHORE_CI
          value: "true"

      prologue:
        commands:
          - sem-version ruby 2.5.7 -f
          - cache restore redmine-4.2 ./redmine
          - cd redmine
          - yarn
          - sem-service start postgres
          - cd plugins
          - checkout
          - cp .semaphore/database.yml ../../config/database.yml
          - bin/setup

      jobs:
        - name: tests
          commands:
            - bin/check

  - name: Redmine 4.1 tests
    execution_time_limit:
      minutes: 5
    dependencies: ["cache"]
    task:
      secrets: []
      env_vars:
        - name: RAILS_ENV
          value: test
        - name: SEMAPHORE_CI
          value: "true"

      prologue:
        commands:
          - sem-version ruby 2.5.4 -f
          - cache restore redmine-4.1 ./redmine
          - cd redmine
          - yarn
          - sem-service start postgres
          - cd plugins
          - checkout
          - cp .semaphore/database.yml ../../config/database.yml
          - bin/setup

      jobs:
        - name: tests
          commands:
            - bin/check

  - name: Redmine 4.0 tests
    execution_time_limit:
      minutes: 5
    dependencies: ["cache"]
    task:
      secrets: []
      env_vars:
        - name: RAILS_ENV
          value: test
        - name: SEMAPHORE_CI
          value: "true"

      prologue:
        commands:
          - sem-version ruby 2.4.0 -f
          - cache restore redmine-4.0 ./redmine
          - cd redmine
          - yarn
          - sem-service start postgres
          - cd plugins
          - checkout
          - cp .semaphore/database.yml ../../config/database.yml
          - bin/setup

      jobs:
        - name: tests
          commands:
            - bin/check
