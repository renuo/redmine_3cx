#!/usr/bin/env bash
cp -n .ruby-version ../../.ruby-version

# Install Dependencies
[[ -v SEMAPHORE_CI ]] && bundle config set --local path vendor/bundle
BUNDLE_GEMFILE=PluginGemfile bundle install -j 4
cd ../..

# Configure Database
db=config/database.yml.example
[[ -v SEMAPHORE_CI ]] && db=plugins/hermes_link/.semaphore/database_postgres.yml
if [[ -v SEMAPHORE_CI ]]; then
	if [[ "$SEMAPHORE_DATABASE_ADAPTER" == "mysql2" ]]; then
		db=plugins/hermes_link/.semaphore/database_mysql.yml
	else
		db=plugins/hermes_link/.semaphore/database_postgres.yml
	fi
fi
cp -n $db config/database.yml

bundle install -j 4
bundle exec rake db:create db:migrate db:seed hermes_link:seed
bundle exec rake redmine:plugins:migrate
